---
title: "Simplified_analysis"
output: pdf_document
date: "2023-06-02"
---

```{r}
detach("package::DRCdemand", unload=TRUE)
remove.packages("DRCdemand")
```

```{r}
devtools::install_github("DylanDijk/DRCdemand")
```

```{r}
library(DRCdemand)
```

```{r}
#sumobj4all <- DRCdemand::clustersum(Irish_adj_train, Irish_adj_test, hcdf, 8)
```

```{r}
stan_code <- "data {
  int<lower=0> N; // number of data items
  int<lower=0> K; // number of predictors
  matrix[N, K] x; // predictor matrix
  vector[N] y; // outcome vector
}
parameters {
  vector[K] beta; // coefficients for predictors
  real<lower=0> tau; // precision parameter
}
transformed parameters {
  real<lower=0> sigma; // standard deviation
  sigma = 1 / sqrt(tau); // Convert precision to standard deviation
}
model {
  tau ~ gamma(2, 0.1); // Gamma prior on the precision
  beta ~ normal(0, 100); // Normal prior on the coefficients
  y ~ normal(x * beta, sigma); // Likelihood
}

generated quantities {
 real y_rep[N];

 for (n in 1:N) {
 y_rep[n] = normal_rng(x[n] * beta, sigma);
 }

}"
```

```{r}
library(parallel)

cl <- makeCluster(4)

clusterEvalQ(cl, c(library(rstan), library(data.table), library(rstanarm), library(DRCdemand)))

clusterExport(cl, c('dataprocess','estimate','fitmodel', 'sumobj4', 'stan_code', 'parfit'))


hc4fixModels <- parLapply(cl, 1:4, function(x){DRCdemand::parfit(sumobj4[['fixed']], stan_code, x, 1)})

stopCluster(cl)
```

```{r}
#clust1 <- DRCdemand::estimate(sumobj4all, hc4allmodels, 1)
```


```{r warning=FALSE}
estobj <- DRCdemand::estimate(sumobj4[["all"]], hc4allmodels, 1)
```


```{r}
library(ggplot2)
predobj <- plotpred(estobj, 4)
ciobj <- t(plotpred(estobj, 1)[1,])
```

```{r}
predobj$plot
```

```{r warning=FALSE}
estobjrand <- DRCdemand::estimate(randsumobj4, rand4models, 1)
```

```{r}
predobjrand <- DRCdemand::plotpred(estobjrand, 1)
```

```{r}
predobjrand$plot
```
```{r}
predobjrand$RMSE
```

```{r}
fix4estobj <- estimate(sumobj4[['fixed']], hc4fixModels, 1)
```

```{r}
predobj4fix <- DRCdemand::plotpred(fix4estobj, 1)
```

```{r}
predobj4fix$plot
```
```{r}
library(rstan)
afds =  extract(hc4allmodels[[1]][[1]])
```
```{r}

library(parallel)
stopCluster(cl)
loop <- list('dem')

for (i in loop){
  
  cl <- makeCluster(4)
  
  clusterEvalQ(cl, c(library(rstan), library(data.table), library(rstanarm), library(DRCdemand)))
  
  clusterExport(cl, c('dataprocess', 'estimate','fitmodel', 'sumobj8', 'stan_code', 'parfit', 'i'))
  
  Models <- parLapply(cl, 1:8, function(x){DRCdemand::parfit(sumobj8[[i]],   stan_code, x, 2)})
  
  varname <- paste(i, 8, sep = '')
  
  assign(varname, Models)
  
  loc = paste('C:/Users/Admin/Documents/models/', varname, '.RData', sep = '')
  
  save(list = varname, file = loc)
  
  stopCluster(cl)
}


cl <- makeCluster(4)

clusterEvalQ(cl, c(library(rstan), library(data.table), library(rstanarm), library(DRCdemand)))

clusterExport(cl, c('dataprocess','estimate','fitmodel', 'sumobj4', 'stan_code', 'parfit'))


hc4demModels <- parLapply(cl, 1:4, function(x){DRCdemand::parfit(sumobj4[['dem']], stan_code, x, 2)})

save(hc4demModels, file = 'C:/Users/Admin/Documents/models/dem4.RData')

stopCluster(cl)



cl <- makeCluster(4)

clusterEvalQ(cl, c(library(rstan), library(data.table), library(rstanarm), library(DRCdemand)))

clusterExport(cl, c('dataprocess','estimate','fitmodel', 'randsumobj8', 'stan_code', 'parfit'))


rand8 <- parLapply(cl, 1:8, function(x){DRCdemand::parfit(randsumobj8, stan_code, x, 2)})

save(rand8, file = 'C:/Users/Admin/Documents/models/rand8.RData')

stopCluster(cl)




